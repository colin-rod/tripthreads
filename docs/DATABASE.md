# Database Architecture & Schema

**Last Updated:** November 2025
**Status:** âœ… Phase 1-2 Complete | ðŸš§ Ongoing Updates

---

## Overview

TripThreads uses **Supabase (PostgreSQL 15+)** for the database. All schema changes are managed through timestamped SQL migration files with rollback support.

---

## Database Migration Management

### Migration File Structure

```
supabase/
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ 20250129000001_create_users_trips_participants.sql
â”‚   â”œâ”€â”€ 20250129000001_create_users_trips_participants_rollback.sql
â”‚   â””â”€â”€ [timestamp]_[description].sql
â”œâ”€â”€ seed.sql                    # Development seed data
â””â”€â”€ config.toml                 # Supabase configuration
```

### Creating Migrations

**IMPORTANT:** When working on database schema changes:

1. **Create timestamped migration files** in `supabase/migrations/`
   - Format: `YYYYMMDDHHMMSS_description.sql`
   - Example: `20250129000001_create_users_trips_participants.sql`

2. **Always create a rollback migration**
   - Format: `YYYYMMDDHHMMSS_description_rollback.sql`
   - Contains SQL to undo the migration

3. **Include in migrations:**
   - Table creation with constraints
   - Indexes for performance
   - RLS (Row-Level Security) policies
   - Triggers and functions
   - Comments for documentation

4. **Migration Best Practices:**
   - Use `IF NOT EXISTS` for idempotent migrations
   - Add comments explaining complex logic
   - Test locally before committing
   - Never edit existing migrations (create new ones)
   - Document breaking changes in commit message

### Applying Migrations

**Local Development:**

```bash
# Method 1: Using Supabase CLI (recommended)
supabase db reset              # Reset database and apply all migrations
supabase db push               # Apply new migrations

# Method 2: Direct SQL execution
psql $DATABASE_URL -f supabase/migrations/20250129000001_create_users_trips_participants.sql
```

**Production:**

```bash
# Via Supabase Dashboard
# 1. Go to SQL Editor in Supabase Dashboard
# 2. Copy migration SQL
# 3. Execute query
# 4. Verify in Table Editor

# Via Supabase CLI (if connected to production)
supabase db push --linked
```

### Rolling Back Migrations

```bash
# Apply rollback migration
psql $DATABASE_URL -f supabase/migrations/20250129000001_create_users_trips_participants_rollback.sql

# Or via Supabase Dashboard SQL Editor
```

### Seeding Data

**Local Development:**

```bash
# Apply seed data
psql $DATABASE_URL -f supabase/seed.sql

# Or via Supabase CLI
supabase db reset  # Resets and seeds automatically
```

**Important Notes:**

- Seed data uses placeholder UUIDs (`00000000-0000-0000-0000-000000000001`)
- Update UUIDs with real auth.users IDs after creating test accounts
- Never run seed.sql in production

### Generating TypeScript Types

After creating migrations, generate TypeScript types:

```bash
# Generate types from local Supabase instance
npm run generate-types

# Or from production/staging database
npm run generate-types:remote
```

**Automated Generation:**

Types are automatically generated by a GitHub Action (`.github/workflows/generate-types.yml`) when:

- Migrations are pushed to `main` or `development`
- Pull requests modify migration files

See [SUPABASE_TYPES_GENERATION.md](SUPABASE_TYPES_GENERATION.md) for full documentation.

### Migration Checklist

When creating a new migration:

- [ ] Migration file created with timestamp
- [ ] Rollback migration created
- [ ] RLS policies defined for all tables
- [ ] Indexes added for foreign keys and common queries
- [ ] Triggers/functions tested
- [ ] Comments added for documentation
- [ ] Migration tested locally with `supabase db reset`
- [ ] Seed data updated if needed
- [ ] TypeScript types regenerated
- [ ] Migration documented in this file
- [ ] Committed with descriptive message

### Example Migration Workflow

```bash
# 1. Create migration files
touch supabase/migrations/20250129120000_add_expenses_table.sql
touch supabase/migrations/20250129120000_add_expenses_table_rollback.sql

# 2. Write SQL in migration file (see existing migrations for examples)

# 3. Test migration locally
supabase db reset  # Applies all migrations + seed

# 4. Generate types
npm run generate-types

# 5. Commit
git add supabase/migrations/ packages/core/src/types/
git commit -m "feat(db): add expenses table with RLS policies"

# 6. Apply to production (via Supabase Dashboard)
```

### Troubleshooting

**Migration fails:**

- Check for syntax errors in SQL
- Ensure foreign key references exist
- Verify RLS policies don't conflict
- Check for unique constraint violations

**RLS blocks queries:**

- Test policies with different user contexts
- Use `auth.uid()` in policies
- Check that user is authenticated

**Types out of sync:**

- Regenerate types: `npm run generate-types`
- Restart TypeScript server in IDE

---

## Database Schema

### Core Entities

#### Users (`profiles` table)

âœ… **Status:** Implemented (Phase 1)

```typescript
interface User {
  id: string // UUID (Supabase Auth)
  email: string
  full_name: string
  avatar_url?: string
  plan: 'free' | 'pro'
  plan_expires_at?: string // ISO 8601
  stripe_customer_id?: string
  created_at: string
  updated_at: string
}
```

**Indexes:**

- Primary key on `id`
- Index on `email`

**RLS Policies:**

- Users can read their own data
- Users can update their own profile
- Service role can manage all users

---

#### Trips (`trips` table)

âœ… **Status:** Implemented (Phase 1)

```typescript
interface Trip {
  id: string // UUID
  name: string
  description?: string
  start_date: string // ISO 8601
  end_date: string // ISO 8601
  owner_id: string // FK â†’ users.id
  cover_image_url?: string
  base_currency: string // ISO 4217 (EUR, USD, GBP, etc.) - Added Phase 2
  created_at: string
  updated_at: string
}
```

**Indexes:**

- Primary key on `id`
- Index on `owner_id`
- Index on `(start_date, end_date)` for date range queries

**RLS Policies:**

- Users can only see trips they're participants in
- Only owners can delete trips
- Participants can update trip details (based on role)

---

#### Trip Participants (`trip_participants` table)

âœ… **Status:** Implemented (Phase 1)

```typescript
interface TripParticipant {
  id: string // UUID
  trip_id: string // FK â†’ trips.id
  user_id: string // FK â†’ users.id
  role: 'owner' | 'participant' | 'viewer'
  joined_at: string // ISO 8601 (for partial joiners)
  invited_by: string // FK â†’ users.id
  can_view_start_date?: string // ISO 8601 (partial joiner visibility)
  can_view_end_date?: string // ISO 8601 (partial joiner visibility)
  notification_preferences?: {
    invites?: boolean | null // Trip invitations (null = inherit from global)
    itinerary?: boolean | null // Itinerary changes (null = inherit from global)
    expenses?: boolean | null // Expense updates (null = inherit from global)
    photos?: boolean | null // Photo uploads (null = inherit from global)
    chat?: boolean | null // Chat messages (null = inherit from global)
    settlements?: boolean | null // Settlement status changes (null = inherit from global)
  } | null // JSONB column, NULL = inherit all from global profiles.notification_preferences
  created_at: string
}
```

**Notification Preferences:**

- Stored as JSONB column for flexibility
- `null` (or missing key) = inherit from global `profiles.notification_preferences`
- `true` = enable for this specific trip (overrides global)
- `false` = disable for this specific trip (overrides global)
- Event types: invites, itinerary, expenses, photos, chat, settlements
- Delivery channels (email/push) inherit from global settings

**Indexes:**

- Primary key on `id`
- Unique index on `(trip_id, user_id)`
- Index on `user_id`
- Index on `trip_id`
- GIN index on `notification_preferences` (for JSONB queries)

**RLS Policies:**

- Users can see participants of trips they belong to
- Only trip owners can modify participant roles
- Participants can leave trips (delete their own participation)
- Participants can update their own notification preferences

---

#### Trip Invites (`trip_invites` table)

âœ… **Status:** Implemented (Phase 1)

```typescript
interface TripInvite {
  id: string // UUID
  trip_id: string // FK â†’ trips.id
  inviter_id: string // FK â†’ users.id
  invitee_email: string // Email of invited user
  role: 'participant' | 'viewer' // Role to assign when accepted
  status: 'pending' | 'accepted' | 'rejected' | 'expired'
  expires_at: string // ISO 8601
  created_at: string
  updated_at: string
}
```

**Indexes:**

- Primary key on `id`
- Index on `trip_id`
- Index on `invitee_email`
- Index on `status`

**RLS Policies:**

- Trip participants can view invites for their trips
- Only owners/participants can create invites
- Invitees can view their own invites
- Invitees can update invite status (accept/reject)

---

#### Access Requests (`access_requests` table)

âœ… **Status:** Implemented (Phase 1)

```typescript
interface AccessRequest {
  id: string // UUID
  trip_id: string // FK â†’ trips.id
  requester_id: string // FK â†’ users.id (user requesting access)
  status: 'pending' | 'approved' | 'rejected'
  message?: string // Optional message from requester
  created_at: string
  updated_at: string
}
```

**Indexes:**

- Primary key on `id`
- Index on `trip_id`
- Index on `requester_id`
- Unique index on `(trip_id, requester_id)` to prevent duplicate requests

**RLS Policies:**

- Trip owners can view all access requests for their trips
- Requesters can view their own access requests
- Trip owners can update request status (approve/reject)

---

#### Itinerary Items (`itinerary_items` table)

âœ… **Status:** Implemented (Phase 2)

```typescript
interface ItineraryItem {
  id: string // UUID
  trip_id: string // FK â†’ trips.id
  type: 'flight' | 'stay' | 'activity'
  title: string
  description?: string
  start_time: string // ISO 8601
  end_time?: string // ISO 8601
  location?: string
  location_lat?: number // Latitude for map integration
  location_lng?: number // Longitude for map integration
  booking_reference?: string // Confirmation number
  cost?: number // Optional cost in cents
  currency?: string // ISO 4217
  url?: string // Booking URL or reference
  created_by: string // FK â†’ users.id
  created_at: string
  updated_at: string
}
```

**Indexes:**

- Primary key on `id`
- Index on `trip_id`
- Index on `(start_time, end_time)` for timeline queries
- Index on `type`

**RLS Policies:**

- Participants see items from their join date forward
- Viewers see all items (read-only)
- Participants can create/edit/delete items
- Partial joiners only see items within their visibility date range

---

#### Expenses (`expenses` table)

âœ… **Status:** Implemented (Phase 2)

```typescript
interface Expense {
  id: string // UUID
  trip_id: string // FK â†’ trips.id
  description: string
  amount: number // Stored as cents/minor units
  currency: string // ISO 4217 (EUR, USD, GBP, etc.)
  category: string // 'food', 'transport', 'accommodation', 'activity', 'other'
  payer_id: string // FK â†’ users.id
  date: string // ISO 8601
  receipt_url?: string // Supabase Storage URL
  fx_rate: number | null // FX rate snapshot (to trip base currency)
  created_by: string // FK â†’ users.id
  created_at: string
  updated_at: string
}
```

**Indexes:**

- Primary key on `id`
- Index on `trip_id`
- Index on `payer_id`
- Index on `date` for chronological queries
- Index on `category` for filtering

**RLS Policies:**

- Participants see expenses they're involved in
- Owners see all expenses
- Viewers cannot see expenses
- Partial joiners only see expenses within their visibility date range

---

#### Expense Participants (`expense_participants` table)

âœ… **Status:** Implemented (Phase 2)

```typescript
interface ExpenseParticipant {
  id: string // UUID
  expense_id: string // FK â†’ expenses.id
  user_id: string // FK â†’ users.id
  share_amount: number // Cents/minor units (in trip's base currency)
  share_type: 'equal' | 'percentage' | 'amount'
  share_value: number // Percentage or custom amount
  created_at: string
}
```

**Indexes:**

- Primary key on `id`
- Unique index on `(expense_id, user_id)`
- Index on `user_id`
- Index on `expense_id`

**RLS Policies:**

- Users can see their own expense participations
- Trip participants can see all expense participants for trip expenses

---

#### Settlements (`settlements` table)

âœ… **Status:** Implemented (Phase 2)

```typescript
interface Settlement {
  id: string // UUID
  trip_id: string // FK â†’ trips.id
  from_user_id: string // FK â†’ users.id (owes money)
  to_user_id: string // FK â†’ users.id (owed money)
  amount: number // Cents/minor units (in trip's base currency)
  currency: string // ISO 4217 (always trip's base currency)
  status: 'pending' | 'settled'
  settled_at?: string // ISO 8601
  created_at: string
  updated_at: string
}
```

**Indexes:**

- Primary key on `id`
- Index on `trip_id`
- Index on `from_user_id`
- Index on `to_user_id`
- Index on `status`

**RLS Policies:**

- Users can see settlements they're involved in (from or to)
- Trip owners can see all settlements for their trips
- Only involved users can update settlement status

---

#### FX Rates (`fx_rates` table)

âœ… **Status:** Implemented (Phase 2)

```typescript
interface FxRate {
  id: string // UUID
  date: string // ISO 8601 date (YYYY-MM-DD)
  from_currency: string // ISO 4217
  to_currency: string // ISO 4217
  rate: number // Exchange rate (to_currency per from_currency)
  source: string // 'openexchangerates' or other provider
  created_at: string
}
```

**Indexes:**

- Primary key on `id`
- Unique index on `(date, from_currency, to_currency)`
- Index on `date` for temporal queries

**RLS Policies:**

- Public read access (FX rates are public data)
- Only service role can insert/update

---

#### Chat Messages (`chat_messages` table)

âœ… **Status:** Implemented (Phase 2)

```typescript
interface ChatMessage {
  id: string // UUID
  trip_id: string // FK â†’ trips.id
  user_id: string // FK â†’ users.id
  message: string // Message content
  created_at: string
  updated_at: string
}
```

**Indexes:**

- Primary key on `id`
- Index on `trip_id`
- Index on `user_id`
- Index on `created_at` for chronological display

**RLS Policies:**

- Trip participants can read messages for their trips
- Trip participants can create messages
- Only message author can update their own messages

---

#### Message Reactions (`message_reactions` table)

âœ… **Status:** Implemented (Phase 2)

```typescript
interface MessageReaction {
  id: string // UUID
  message_id: string // FK â†’ chat_messages.id
  user_id: string // FK â†’ users.id
  emoji: string // Emoji character or shortcode
  created_at: string
}
```

**Indexes:**

- Primary key on `id`
- Unique index on `(message_id, user_id, emoji)` to prevent duplicate reactions
- Index on `message_id`

**RLS Policies:**

- Trip participants can view reactions on messages in their trips
- Users can create their own reactions
- Users can delete their own reactions

---

#### Media Files (`media_files` table)

ðŸ“‹ **Status:** Planned (Phase 3)

```typescript
interface MediaFile {
  id: string // UUID
  trip_id: string // FK â†’ trips.id
  user_id: string // FK â†’ users.id
  type: 'photo' | 'video'
  url: string // Supabase Storage URL
  thumbnail_url?: string
  caption?: string
  date_taken: string // ISO 8601 (auto-tagged to day)
  created_at: string
}
```

**Planned Indexes:**

- Primary key on `id`
- Index on `trip_id`
- Index on `user_id`
- Index on `date_taken` for chronological display

**Planned RLS Policies:**

- All trip participants see all photos
- Viewers can see photos (read-only)
- Participants can upload photos

---

#### Push Tokens (`push_tokens` table)

ðŸ“‹ **Status:** Planned (Phase 4)

```typescript
interface PushToken {
  id: string // UUID
  user_id: string // FK â†’ users.id
  token: string // Expo push token or VAPID endpoint
  platform: 'web' | 'ios' | 'android'
  created_at: string
  updated_at: string
}
```

**Planned Indexes:**

- Primary key on `id`
- Unique index on `(user_id, token)` to prevent duplicates
- Index on `user_id`

**Planned RLS Policies:**

- Users can manage their own push tokens
- Service role can read all tokens for sending notifications

---

## Data Relationships

```
users
  â”œâ”€â”€ trips (as owner)
  â”œâ”€â”€ trip_participants (as participant)
  â”œâ”€â”€ expenses (as payer)
  â”œâ”€â”€ expense_participants (as participant)
  â”œâ”€â”€ chat_messages (as author)
  â”œâ”€â”€ message_reactions (as reactor)
  â”œâ”€â”€ media_files (as uploader) [Phase 3]
  â””â”€â”€ settlements (as debtor or creditor)

trips
  â”œâ”€â”€ trip_participants (many)
  â”œâ”€â”€ trip_invites (many)
  â”œâ”€â”€ access_requests (many)
  â”œâ”€â”€ itinerary_items (many)
  â”œâ”€â”€ expenses (many)
  â”œâ”€â”€ chat_messages (many)
  â”œâ”€â”€ media_files (many) [Phase 3]
  â””â”€â”€ settlements (many)

expenses
  â”œâ”€â”€ expense_participants (many)
  â””â”€â”€ payer (one user)

chat_messages
  â””â”€â”€ message_reactions (many)
```

---

## Row-Level Security (RLS) Policies

All tables use RLS to enforce access control:

### Trips

- Users can only see trips they're participants in
- Only owners can delete trips

### Itinerary Items

- Participants see items from their join date forward
- Viewers see all items (read-only)
- Participants can create/edit items
- Partial joiners only see items within their visibility date range

### Expenses

- Participants see expenses they're involved in
- Owners see all expenses
- Viewers cannot see expenses
- Partial joiners only see expenses within their visibility date range
- Expense proration: Partial joiners' shares are automatically adjusted based on their join/leave dates

### Chat Messages

- Trip participants can read all messages in their trips
- Participants can create messages
- Authors can edit/delete their own messages

### Media Files [Phase 3]

- All trip participants see all photos
- Viewers can see photos (read-only)
- Participants can upload photos

---

## Implemented Migrations

### Baseline (Dec 2025)

- âœ… **`20251201000000_baseline_schema.sql`** - Consolidated production schema
  - Replaces 31 Phase 1-2 migrations (Jan-Nov 2025)
  - Archived originals in `supabase/migrations/archive/2025-phase1-phase2/`
  - Source: Production database dump
  - Contains: Core tables, RLS policies, triggers, functions, indexes, comments
  - Eliminates historical complexity (RLS recursion fixes, table renames, search_path issues)

### Phase 1: Core Foundation (Archived)

1. âœ… `20250129000001_create_users_trips_participants.sql` - Core tables
2. âœ… `20250129000006_add_profile_fields.sql` - User profile enhancements
3. âœ… `20250129000007_create_trip_invites.sql` - Invitation system
4. âœ… `20250131000001_create_access_requests.sql` - Access request system

### Phase 2: Itinerary & Ledger

5. âœ… `20250129000002_add_date_scoped_rls_and_tables.sql` - Expenses and itinerary
6. âœ… `20250130000001_add_partial_joiner_dates.sql` - Partial joiner date visibility
7. âœ… `20250130000002_update_rls_for_partial_joiners.sql` - RLS for partial joiners
8. âœ… `20250130000003_expense_proration_for_partial_joiners.sql` - Expense proration
9. âœ… `20250129000003_create_settlements_table.sql` - Settlement tracking
10. âœ… `20250207000001_enhance_itinerary_items.sql` - Enhanced itinerary fields
11. âœ… `20250208000001_add_fx_rates_and_base_currency.sql` - Multi-currency support
12. âœ… `20250206000001_create_chat_messages.sql` - Trip chat
13. âœ… `20250208000002_create_message_reactions.sql` - Message reactions

### RLS Fixes

- âœ… `20250129000003_fix_rls_infinite_recursion.sql`
- âœ… `20250129000004_fix_can_user_see_item_recursion.sql`
- âœ… `20250129000005_fix_remaining_rls_recursion.sql`

---

## Notification System

### Overview

âœ… **Status:** Implemented (CRO-767 - Phase 2.5)

The notification system uses Supabase Edge Functions triggered by database events to send email notifications when trip events occur. It respects user preferences with a three-state inheritance model (trip-specific override, global fallback, or default false).

### Architecture

**Components:**

1. **Database Triggers** - Invoke edge functions on INSERT/UPDATE events
2. **Edge Functions** - Process events and send notifications via Resend API
3. **Notification Logs** - Audit trail for all notification attempts
4. **Shared Utilities** - Reusable preference checking and filtering logic

### notification_logs Table

```sql
CREATE TABLE public.notification_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id UUID NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  event_type TEXT NOT NULL CHECK (event_type IN ('invites', 'itinerary', 'expenses', 'photos', 'chat', 'settlements')),
  notification_type TEXT NOT NULL CHECK (notification_type IN ('email', 'push')),
  status TEXT NOT NULL CHECK (status IN ('sent', 'skipped', 'failed')),
  skip_reason TEXT,
  error_message TEXT,
  metadata JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**Purpose:**

- Audit trail for all notification delivery attempts
- Testing without external API calls
- Analytics on notification engagement
- Debugging failed deliveries

**Indexes:**

- `idx_notification_logs_trip_id` - Filter by trip
- `idx_notification_logs_user_id` - Filter by user
- `idx_notification_logs_event_type` - Filter by event type
- `idx_notification_logs_status` - Filter by status
- `idx_notification_logs_created_at` - Time-based queries
- `idx_notification_logs_trip_event_created` - Composite for trip analytics

**RLS Policies:**

- Users can read their own logs
- Trip participants can read logs for their trips
- Service role can insert logs (edge functions)

### Edge Functions

**Implemented Functions:**

| Function                            | Trigger Event                               | Description                                |
| ----------------------------------- | ------------------------------------------- | ------------------------------------------ |
| `send-access-request-email`         | `access_requests` INSERT                    | Notify trip owner of access request        |
| `send-invite-accepted-notification` | `trip_participants` INSERT                  | Notify existing participants of new member |
| `send-itinerary-notification`       | `itinerary_items` INSERT/UPDATE             | Notify participants of itinerary changes   |
| `send-expense-notification`         | `expenses` INSERT                           | Notify participants of new expense         |
| `send-settlement-notification`      | `settlements` UPDATE (pending â†’ settled)    | Notify both parties of settlement          |
| `send-chat-notification`            | `chat_messages` INSERT (user messages only) | Notify participants of new chat message    |
| `send-photo-notification`           | `media_files` INSERT (Phase 3)              | Stub for future photo notifications        |

**Shared Utilities** (`supabase/functions/_shared/notifications.ts`):

- `getEffectivePreference()` - Implements preference inheritance logic
- `fetchNotificationRecipients()` - Fetches trip participants with preferences
- `filterRecipientsAndLog()` - Filters by preferences and logs decisions
- `sendEmailNotification()` - Sends email via Resend API
- `logNotification()` - Records notification attempt
- `checkUserPreference()` - Checks if user should be notified

### Notification Preferences

**Three-State Inheritance Model:**

1. **Trip-Specific Override** - `trip_participants.notification_preferences[event_type]`
   - `true` = enabled for this trip
   - `false` = disabled for this trip
   - `null` = inherit from global

2. **Global Default** - `profiles.notification_preferences[channel_event_type]`
   - `true` = enabled globally
   - `false` = disabled globally

3. **System Default** - `false` (opt-in model)
   - If no preference set, don't send notifications

**Example:**

```typescript
// User has global expense notifications enabled
profiles.notification_preferences = {
  email_expense_updates: true,
  email_trip_updates: false,
}

// But disabled for specific trip
trip_participants.notification_preferences = {
  expenses: false,
}

// Result: No expense notifications for this trip
// Chat/itinerary notifications still disabled (global = false)
```

**Event Type to Global Preference Mapping:**

| Event Type    | Email Global Key        | Push Global Key        |
| ------------- | ----------------------- | ---------------------- |
| `invites`     | `email_trip_invites`    | `push_trip_invites`    |
| `itinerary`   | `email_trip_updates`    | `push_trip_updates`    |
| `expenses`    | `email_expense_updates` | `push_expense_updates` |
| `photos`      | `email_trip_updates`    | `push_trip_updates`    |
| `chat`        | `email_trip_updates`    | `push_trip_updates`    |
| `settlements` | `email_expense_updates` | `push_expense_updates` |

### Database Triggers

**Trigger Functions:**

```sql
-- Invite accepted
CREATE TRIGGER on_trip_participant_insert
  AFTER INSERT ON trip_participants
  FOR EACH ROW EXECUTE FUNCTION notify_invite_accepted();

-- Itinerary change
CREATE TRIGGER on_itinerary_item_insert
  AFTER INSERT ON itinerary_items
  FOR EACH ROW EXECUTE FUNCTION notify_itinerary_change();

CREATE TRIGGER on_itinerary_item_update
  AFTER UPDATE ON itinerary_items
  FOR EACH ROW EXECUTE FUNCTION notify_itinerary_change();

-- Expense added
CREATE TRIGGER on_expense_insert
  AFTER INSERT ON expenses
  FOR EACH ROW EXECUTE FUNCTION notify_expense_added();

-- Settlement status change
CREATE TRIGGER on_settlement_status_change
  AFTER UPDATE ON settlements
  FOR EACH ROW EXECUTE FUNCTION notify_settlement_status_change();

-- Chat message
CREATE TRIGGER on_chat_message_insert
  AFTER INSERT ON chat_messages
  FOR EACH ROW EXECUTE FUNCTION notify_chat_message();
```

**How Triggers Work:**

1. Database event occurs (INSERT/UPDATE)
2. Trigger function invokes edge function via `pg_net.http_post()`
3. Edge function receives webhook payload
4. Edge function processes event and sends notifications
5. All decisions logged to `notification_logs`

### Notification Flow

**Example: New Expense Added**

1. User creates expense â†’ INSERT into `expenses` table
2. `on_expense_insert` trigger fires
3. Trigger invokes `send-expense-notification` edge function
4. Edge function:
   - Fetches expense details with trip/user info
   - Fetches all trip participants (excluding expense creator)
   - Filters by notification preferences:
     - Check trip-specific `expenses` preference
     - Fall back to global `email_expense_updates`
     - Default to `false` if not set
   - Sends email to each recipient via Resend API
   - Logs each notification attempt (sent/skipped/failed)
5. Recipients receive email with expense details

### Testing

**Unit Tests** (`supabase/functions/_shared/__tests__/notifications.test.ts`):

- Preference inheritance logic (27 tests)
- Event type to global preference mapping
- Edge cases (null, undefined, empty objects)
- Real-world scenarios

**Integration Tests** (`supabase/functions/__tests__/integration/notification-flow.test.ts`):

- End-to-end notification delivery (mocked API)
- Recipient filtering with mixed preferences
- Email delivery success/failure
- Notification logging

**Running Tests:**

```bash
cd supabase/functions/_shared
deno test --allow-env --allow-net __tests__/notifications.test.ts

cd supabase/functions
deno test --allow-env --allow-net __tests__/integration/notification-flow.test.ts
```

### Email Templates

All edge functions use responsive HTML email templates with:

- TripThreads branding (ðŸ§µ logo, orange accent color)
- Event-specific content (expense details, itinerary changes, etc.)
- Call-to-action button (View Trip, Reply in Chat, etc.)
- Preference management links
- Responsive design for mobile/desktop

### Rate Limiting Considerations

**Current Implementation:**

- No rate limiting on edge functions
- Each event triggers individual emails
- Chat notifications include warning about potential spam

**Future Improvements (if needed):**

- Batch notifications for high-frequency events (chat)
- Digest emails (e.g., daily summary instead of per-message)
- Per-user rate limits in edge functions
- Notification throttling for noisy trips

### Environment Variables

Edge functions require:

```bash
# Supabase (auto-provided)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Resend API (must set in Supabase Dashboard)
RESEND_API_KEY=re_your_api_key

# Frontend URL (for email links)
FRONTEND_URL=https://tripthreads.com
```

### Migration Files

- âœ… `20251128000001_create_notification_logs.sql` - Creates notification_logs table
- âœ… `20251128000001_create_notification_logs_rollback.sql` - Rollback migration
- âœ… `20251128000002_create_notification_triggers.sql` - Creates trigger functions
- âœ… `20251128000002_create_notification_triggers_rollback.sql` - Rollback triggers

---

## Future Schema Additions

### Phase 3: Media & Pro Features

ðŸ“‹ **Planned:**

- `media_files` table for photo/video storage
- Stripe integration fields (customer_id, subscription_id)
- Pro tier limits enforcement

### Phase 4: Push Notifications & Recap

ðŸ“‹ **Planned:**

- `push_tokens` table for notification delivery
- `trip_recaps` table for PDF generation metadata

### Phase 5: Post-MVP

ðŸ“‹ **Potential:**

- Real-time presence tracking
- Task/checklist tables
- Poll/voting tables
- Activity feed/timeline table

---

## Performance Considerations

### Implemented Optimizations

âœ… **Indexes:**

- All foreign keys have indexes
- Composite indexes on common query patterns (e.g., `trip_id + date`)
- Unique constraints prevent duplicate data

âœ… **RLS Optimization:**

- Recent fixes eliminated infinite recursion
- Efficient date range checks for partial joiners
- Minimized number of policy checks per query

### Future Optimizations

ðŸ“‹ **Planned:**

- Materialized views for complex ledger calculations
- Partitioning for large media tables
- Redis caching for frequently accessed data (trip metadata, user profiles)

---

## Backup & Recovery

### Current Strategy

- Automatic daily backups via Supabase (7-day retention on free tier)
- Point-in-time recovery available on Pro plan
- All migrations in version control for rebuild capability

### Disaster Recovery Plan

1. Restore from most recent Supabase backup
2. Reapply any recent migrations from git
3. Verify data integrity with test suite
4. Communicate downtime to users

---

**For more documentation:**

- [TESTING.md](TESTING.md) - Testing strategy and examples
- [CICD.md](CICD.md) - Deployment pipeline
- [CLAUDE.md](../CLAUDE.md) - Main project documentation
